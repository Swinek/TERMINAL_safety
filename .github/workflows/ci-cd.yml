# Plik: .github/workflows/ci-cd.yml

name: .NET and Node.js CI/CD

# Wyzwalacze: Uruchom ten potok (pipeline) przy...
on:
  push:
    branches: [ "main" ] # ...ka≈ºdym 'push' do ga≈Çƒôzi 'main'
  pull_request:
    branches: [ "main" ] # ...ka≈ºdym 'pull request' kierowanym do 'main'

jobs:
  # === ETAP 1: TESTOWANIE ===

  lint-frontend:
    name: üé® Lint Frontend
    runs-on: ubuntu-latest
    steps:
    - name: Pobranie kodu
      uses: actions/checkout@v4

    - name: Ustawienie Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20 # U≈ºyj wersji Node.js, kt√≥rej u≈ºywasz

    - name: Instalacja zale≈ºno≈õci klienta
      working-directory: ./Client
      run: npm ci # 'ci' jest szybsze i bezpieczniejsze dla CI ni≈º 'install'

    - name: Uruchomienie Lintera (ESLint)
      working-directory: ./Client
      run: npm run lint # Zak≈ÇadajƒÖc, ≈ºe masz skrypt 'lint' w package.json

  test-backend:
    name: üß™ Test Backend (.NET)
    runs-on: ubuntu-latest
    steps:
    - name: Pobranie kodu
      uses: actions/checkout@v4

    - name: Ustawienie .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x # U≈ºyj wersji .NET, kt√≥rej u≈ºywasz

    - name: Uruchomienie test√≥w .NET
      run: dotnet test ./Server/Terminal.Backend.sln --configuration Release

  test-e2e:
    name: üé≠ Test End-to-End (Playwright)
    runs-on: ubuntu-latest
    # Uruchom ten test tylko, je≈õli linting i testy backendu przesz≈Çy pomy≈õlnie
    needs: [lint-frontend, test-backend]
    steps:
    - name: Pobranie kodu
      uses: actions/checkout@v4

    - name: Ustawienie Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Uruchomienie us≈Çug (Backend + Frontend)
      # U≈ºywamy pliku produkcyjnego, aby testowaƒá to, co p√≥jdzie na produkcjƒô
      run: docker-compose -f compose.yaml -f compose.prod.yaml up -d
    
    - name: Czekaj na uruchomienie us≈Çug
      run: sleep 20 # Daje czas kontenerom na pe≈Çne uruchomienie

    - name: Instalacja zale≈ºno≈õci klienta (w tym Playwright)
      working-directory: ./Client
      run: npm ci

    - name: Instalacja przeglƒÖdarek dla Playwright
      working-directory: ./Client
      run: npx playwright install --with-deps

    - name: Uruchomienie test√≥w Playwright
      working-directory: ./Client
      run: npx playwright test # Uruchamia testy ze specyfikacji

    - name: Zatrzymanie us≈Çug
      # Uruchom ten krok zawsze, nawet je≈õli testy siƒô nie powiodƒÖ
      if: always()
      run: docker-compose -f compose.yaml -f compose.prod.yaml down

  # === ETAP 2: WDRA≈ªANIE (CD) ===

  deploy:
    name: üöÄ Wdra≈ºanie na Produkcjƒô
    runs-on: ubuntu-latest
    # Zale≈ºno≈õci: Uruchom tylko po pomy≈õlnym te≈õcie E2E
    needs: test-e2e
    
    # Warunek: Uruchom ten krok TYLKO przy 'push' do 'main',
    # a NIE przy pull requestach.
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Pobranie kodu
      uses: actions/checkout@v4

    - name: Ustawienie klucza SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Dodanie serwera do znanych host√≥w
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Instalacja Ansible
      run: pip install ansible

    - name: Uruchomienie Ansible Playbook
      working-directory: ./ansible
      run: |
        # U≈ºyj flagi -i do podania hosta i u≈ºytkownika
        ansible-playbook deploy-playbook.yml \
          -i ${{ secrets.DEPLOY_HOST }}, \
          --user ${{ secrets.DEPLOY_USER }}